\section{Inclusion of the edge set in the construction}
\label{sec:edges}

%\subsection{Introduction}

The constructions from the previous section involve the vertex set $V$ and depend on $\Gamma$, a subgroup of the set of invertible transformations on $V$. Therefore, it looks natural to try to relate the edge set and $\Gamma$.

There are two point of views. Either $\Gamma$ describes an underlying graph structure $\gve$, either $G$ can be used to define a relevant subgroup $\Gamma$ to which the produced convolutive operators will be equivariant. Both approaches will help characterize classes of graphs that can support natural definitions of convolutions.

%\todo{introduction to be developped more}

%%
%% Draft
%%

%%% What follows is to be reworded and put in the neural network section !
% However we must keep in mind that the resulting convolution would be meant to breed a class of operators that are equivariant to $\Gamma$. In an application where this property is not relevant, such operators would produce layers that are less expressive than dense counterparts. So it is not always possible to leverage a graph structure coming with a dataset if one cannot build meaningful transformations from it. 

\subsection{Edge-constrained convolutions}
\label{sec:cayley}

In this subsection, we are trying to answser the following question:
\begin{itemize}
	\item What graphs admit a $\varphi$-convolution, or an $\M$-convolution (in the sense that they can be defined with the characterization), under the condition that $\Gamma$ is generated by a set of edge-constrained transformations ?
\end{itemize}

\begin{definition}\textbf{Edge-constrained transformation}\\
An \emph{edge-constrained} (EC) transformation on a graph $\gve$ is a transformation $f: V \mapsto V$ such that
\begin{gather*}
\forall u,v \in V, f(u) = v \Rightarrow u \overset{E}{\sim} v
\end{gather*}
\end{definition}

We denote $\Phi_{\EC}(G)$ and $\Phi^*_{\EC}(G)$ the sets of EC and invertible EC transformations. When a convolution is defined as a sum over a set that is in one-to-one correspondence with a group that is generated from a set of EC transformations, we call it an EC convolution.

\begin{remark}
Note that $\Phi^*_{\EC}(G)$ is not a group, that is why we are interested in groups and their generating sets.
\end{remark}

This leads us to consider Cayley graphs~\citep{cayley1878desiderata}.%,wiki:cayley}.

\begin{definition}\textbf{Cayley graph}\\
Let a group $\Gamma$ and one of its generating set $\cu$. The \emph{Cayley graph} generated by $\cu$, is the digraph $\vgve$ such that $V = \Gamma$ and $E$ is such that, either:
\begin{itemize}[nolistsep,noitemsep]
\item $\forall a,b \in \Gamma, a \rightarrow b \Leftrightarrow \exists g \in \cu, ga = b \quad$ (\emph{left Cayley graph})
\item $\forall a,b \in \Gamma, a \rightarrow b \Leftrightarrow \exists g \in \cu, ag = b \quad$ (\emph{right Cayley graph})
\end{itemize}
In case $\Gamma$ is abelian, we call it an $\emph{abelian Cayley graph}$. Also, we call \emph{Cayley subgraph} a subgraph that is isomorph to a Cayley graph.
\end{definition}

\begin{remark}
Note that in the literature, a Cayley graph is usually what we defined as a right one. In what follows, we could have used right Cayley graphs instead of left ones, but since we want $g$ to be an EC transformation, we would have had to use the group action $g(a) = L_g(a) = ag$ for the $\varphi$-convolution, which is inconvenient with the functional notation. Recall that instead, we defined $\varphi$-equivalence with a group action corresponding to left multiplication.
\end{remark}

\paragraph{Convolution on Cayley graphs}
In the case of left Cayley graphs, it is clear that $\cu \subseteq \Phi^*_{\EC}$ and $\Phi^* \supseteq \langle \cu \rangle \equiv V$. So that they admit EC $\varphi$-convolutions, and EC $\M$-convolutions in the abelian case.

More precisely, we obtain the following characterization:

\begin{theorem}\textbf{EC characterization by left Cayley subgraph}\\
Let a graph $\gve$, then:
\begin{enumerate}[label=(\roman*)]
\item $G$ admits an EC $\varphi$-convolution if and only if it contains a left Cayley subgraph
\item $G$ admits an EC $\M$-convolution if and only if it contains an abelian Cayley subgraph
\end{enumerate}
\label{th:cayleychar}
\end{theorem}

\begin{proof}

\todo{Vincent peux-tu vérifier cette preuve stp?}

We show the result only in the general case as the proof for the abelian case is similar.
\begin{enumerate}
	\item From left to right: as a direct application of the definitions.

	\item From right to left:\\
Let a graph $\gve$. We suppose it contains a subgraph $\vec{G_s} = \langle V_s, E_s \rangle$ that is graph-isomorph to a left Cayley graph $\vec{G_c} = \langle V_c, E_c \rangle$, generated by $\cu$. Let $\psi$ be a graph isomorphism from $G_s$ to $G_c$. To obtain the proof, we need to find a group of invertible transformations $\Gamma$ of $V_s$ generated by a set of EC transformations, such that $\Gamma \equiv V_s$.

Let's define the group action $L : V_c \times V_s \rightarrow V_s$ inductively as follows:
\begin{enumerate}[label=(\alph*)]
  \item $\forall g \in \cu, L_g(u) = v \Leftrightarrow g\psi(u) = \psi(v)$ \label{enum:a}
  \item Whenever $L_g$ and $L_h$ are defined, the action of $gh$ is defined by homomorphism as $L_{gh}= L_g \circ L_h$ \label{enum:b}
  \item Whenever $L_g$ is defined, the action of $g^{-1}$ is defined by homomorphism as $L_{g^{-1}}=L_g^{-1}$ \ie $L_{g^{-1}}(u) = v \Leftrightarrow \psi(u) = g\psi(v)$ \label{enum:c}
\end{enumerate}

Note that the induction transfers the property \ref{enum:a} to all $g \in V_c$ in a transitive manner because
\begin{gather*}
L_{gh}(u) = L_g(L_h(u)) = w \Leftrightarrow \exists v \in V_s
\begin{cases}
L_h(u) = v\\
L_g(v) = w
\end{cases}
\end{gather*}
and
\begin{gather*}
\exists v \in V_s
\begin{cases}
h\psi(u) = \psi(v)\\
g\psi(v) = \psi(w)
\end{cases}
\Leftrightarrow gh\psi(u) = \psi(w)
\end{gather*}

We must also verify that this construction is well-defined, \ie whenever we define an action with \ref{enum:b} or \ref{enum:c}, if the action was already defined, then they must be equal. This is the case because the homomorphism $g \mapsto L_g$ on $V_c$ is in fact an isomorphism as
\begin{align*}
L_g = L_h & \Leftrightarrow \forall u \in V, L_g(u) = L_h(u)\\
 & \Leftrightarrow \forall u \in V, g\psi(u) = h\psi(u)\\
 & \Leftrightarrow g = h
\end{align*}

Also note that \ref{enum:c} is needed only in case that $V_c$ is infinite.

Denote the set $L_{\cu} = \{L_g, g \in \cu \}$ and $\Gamma = \langle L_{\cu} \rangle \cong V_c$. Let's define the map $\varphi$ as:
\begin{align*}
\Gamma & \rightarrow V_s\\
\varphi: L_g & \mapsto L_g(\psi^{-1}(\id))
\end{align*}
$\varphi$ is bijective because $\forall g \in V_c, \varphi(L_g) = \psi^{-1}(g)$ thanks to \ref{enum:a}.

Additionally, we have:
\begin{align*}
L_h(\varphi(L_g) & = L_h(L_g(\psi^{-1}(\id)))\\
 & = L_h \circ L_g(\psi^{-1}(\id))\\
 & = L_{hg}(\psi^{-1}(\id))\\
 & = \varphi(L_{hg})\\
 & = \varphi(L_h \circ L_g)
\end{align*}
That is, $\varphi$ is a bijective equivariant map and $ \langle L_{\cu} \rangle = \Gamma \overset{\varphi}{\equiv} V_s$. Moreover, $L_{\cu}$ is a set of EC transformations thanks to \ref{enum:a}. Therefore, $G$ admits an EC~$\varphi$-convolution.
\end{enumerate}
\end{proof}

\begin{corrolary}\textbf{Characterization by $\varphi$}\\
Let a graph $\gve$, and a set $\cu \subset \Phi^*_{\EC}(G)$ \st
\begin{gather*}
\langle \cu \rangle \cong \Gamma \equiv V' \subset V
\end{gather*}
$G$ admits an EC $\varphi$-convolution, if and only if, $\varphi$ is a graph isomorphism between the left Cayley graph generated by $\cu$ and the subgraph induced by~$V'$.
\label{cor:cayley}
\end{corrolary}
The proof is omitted as it would be highly similar to the previous one.

\subsection{Intrinsic properties}

\begin{itemize}
  \item Obviously the constructed convolutions are linear. But do they also preserve the locality and weight sharing properties ?
\end{itemize}

%Let $\vgve$ be a left Cayley subgraph, generated by $\cu$, of some graph $G$.
Recall that a $\varphi$-convolution operator is a right operator, and can be expressed as
\begin{align}
\forall s \in \cs(V) &, \forall u \in V,\nonumber\\
f_w(s)[u] & = (s \ast_{\varphi} w) [u]\nonumber
            = \displaystyle\sum_{v \in V} s[v] \h{2} w[g_v^{-1}(u)] \label{eq:sum}
\end{align}

From this expression, it is not obvious that $f_w$ is a local operator. First we must define a notion of locality.

\begin{definition}\textbf{Compact (of a graph)}\\
Let a graph $\gve$. A subset of the vertex set $\ck \in V$ is said to be \emph{compact} if its induced subgraph in $G$ is connected.
\end{definition}

Roughly speaking, we want for our notion of locality that when the support of $w$ is small and compact, then $f_w(s)[u]$ should be defined by a sum of a few corresponding $v$ too. This translates into the following definition.

\begin{definition}\textbf{Compactly supported $\varphi$-convolution operator}\\
A $\varphi$-convolution operator $f_w$ is said to be Compactly Supported (CS) if
\begin{enumerate}[nolistsep,noitemsep]
  \item $\supp(w)$ is a compact, and
  \item given $u \in V$, there is a graph isomorphism between $\supp(w)$ and $\supp(\sigma_u)$, where $\sigma_u: v \to s[v] \h{2} w[g_v^{-1}(u)]$ (so that $f_w(s)[u] = \sum_{v \in V} \sigma_u(v)$)
\end{enumerate}
\end{definition}

Before characterizing CS convolution operators, we demonstrate this lemma.

\begin{lemma}
On right Cayley graphs, left multiplication operators are automorphisms (and vice-versa).
\label{lem:lat}
\end{lemma}
\begin{proof}
Since $a \rightarrow b \Leftrightarrow ag = b \Leftrightarrow hag = hb \Leftrightarrow ha \rightarrow hb$.
\end{proof}

We obtain the following theorem, which is the lateral symmetry of the formulation of \thref{th:cayleychar}.

\begin{theorem}\textbf{CS characterization by right Cayley subgraph}\\
Let a graph $\gve$, then:
\begin{enumerate}[label=(\roman*)]
\item $G$ admits a CS $\varphi$-convolution if and only if it contains a right Cayley subgraph
\item $G$ admits a CS $\M$-convolution if and only if it contains an abelian Cayley subgraph
\end{enumerate}
\label{th:cscayleychar}
\end{theorem}

\begin{proof}
We only demonstrate the first case as the proof in the abelian case is similar.

%\begin{enumerate}


\todo{Vincent, peux-tu m'aider stp à démontrer cette preuve à l'aide du lemme 66, quitte à modifier la définition 65?}
 % \item From left to right:

% Let $V_c = \supp(w) \displaystyle\cup_{u \in V} \supp(\sigma_u)$, $\Gamma_c = \varphi^{-1}(V_c)$ and the right Cayley graph $\vec{G_c} = \langle \Gamma_c, E_c \rangle$.
% $ag = b$ $\varphi(a) \sim \varphi$
%Let $u \in V$, we denote $h_u: \supp(x) \to \supp(\sigma_u)$ an isomorphism. $h_a(x) = y$, $h_b(x) = y$
%Sabidussi's theorem


%   \item From right to left:

% Let a right Cayley subgraph 


% Without loss of generality subject to growing $\cu$, let's suppose that $w$ has a support $\cm = \varphi(\cn)$, such that $\cn \subset \cu$. $\cn$ and $\cm$ are obviously compacts of diameter $2$. Thanks to \eqref{eq:P}, we have 
% \begin{align*}
% g_v^{-1}(u) \in \cm & \Leftrightarrow \varphi(g_v^{-1} g_u)


% u \in g_v(\cm) = g_v(\varphi(\cn)) = \varphi(g_v\cn)\\
% & \Leftrightarrow g_u \in g_v\cn\\
% & \Leftrightarrow g_v^{-1} \in \cn g_u^{-1}\\
% & \Leftrightarrow g_v \in g_u \cn^{-1} = g_u \cn\\
% & \Leftrightarrow v \in g_u(\varphi(\cn)) = g_u(\cm)
% \end{align*}

% Thanks to \lemref{lem:lat}, $g_u$ is an isomorphism. Similarly than for the proof of $\thref{cayleychar}$, we can show that $\varphi$ is also an isomorphism. \todo{Vincent peut m'aider pour formuler cette preuve ?} $\cn^{-1}$ reverses the edges of $\cn$ and though it is not a digraph isomorphism, it amounts to the identity for a graph. Their composition is an isomorphism.% By composing edge reversal and graph isomorphisms (as $\varphi$ and its inverse are graph isomorphisms by \corref{cor:cayley}), the compactness and diameter of~$\cm$ is preserved for $\ck_u$. More precisely, the transposed subgraph structure is also preserved.
%\end{enumerate}
\end{proof}

%\todo{reformulate what follows}

Let's denote $\ck_u = g_u(\varphi(\cn^{-1})) \subset V$.
Let's define $\cm$, $\cn$ as in the previous proof. We call $\cn$ the \emph{supporting set} of the convolution.

\begin{definition}\textbf{Supporting set}\\
The \emph{supporting set} of an EC convolution operator $f_w$, is a set $\cn \subset \Phi^*_{\EC}$, such that
\begin{enumerate}[label=(\roman*)]
  \item when $\ast \text{ is } \ast_\varphi$: $0 \notin w[\cm]$, where $\cm= \varphi(\cn)$ \label{enum:i}
  \item when $\ast \text{ is } \ast_{\M}$: $0 \notin w[\cn]$ \label{enum:ii}
\end{enumerate}
\end{definition}

\begin{definition}\textbf{Local patch for $\ast_\varphi$}\\
The \emph{local patch} at $u \in V$ of an EC $\varphi$-convolution operator $f_w$ is defined as $\ck_u = g_u(\varphi(\cn^{-1}))$.
\end{definition}

\begin{remark}
In other terms, $\ck_{\id} = \varphi(\cn^{-1})$ is the \emph{initial local patch}, which is composed of all vertices that are connected in direction to $\varphi(\id)$; and $\ck_u$ is obtained by moving $\ck_{\id} $ on the Cayley subgraph via the edges corresponding to the decomposition of $g_u$ on the generating set $\cu$.
\end{remark}

To see that the weights are tied in the general case \ref{enum:i}, we can show the following proposition.

\begin{proposition}\textbf{Weight sharing}\\
$\forall a, \alpha \in V, \forall b \in \ck_a: \exists \beta \in \ck_{\alpha} \Leftrightarrow g_{\beta}^{-1}(\alpha) = g_{b}^{-1}(a)$
\end{proposition}
\begin{proof}
By using \eqref{eq:P},
\begin{align*}
g_{\ck_\alpha}^{-1}(\alpha) = g_{\ck_a}^{-1}(a)
	& \Leftrightarrow  g_{\alpha}^{-1}g_{\ck_{\alpha}} = g_a^{-1}g_{\ck_a}\\
	& \Leftrightarrow  \ck_{\alpha} = g_{\alpha}g_a^{-1}(\ck_a) = g_{\alpha}g_a^{-1}g_a(\varphi(\cn^{-1}))\\
	& \Leftrightarrow  \ck_{\alpha} = g_{\alpha}(\varphi(\cn^{-1}))
\end{align*}
\end{proof}

\subsection{Stricly edge-constrained convolutions}
\label{sec:ec}

We make the disctinction between general EC convolution operators and those for which the weight kernel $w$ is smaller and is supported only on EC transformations of $\cu$.

\begin{definition}\textbf{Strictly EC convolution operator}\\
A \emph{strictly} edge-constrained (EC*) convolution operator $f_w$, is an EC convolution operator such that its supporting set $\cn \subset \cu$.
\end{definition}

\begin{remark}EC* convolution operators are simpler to obtain as we can construct them just with $\cu \subset \Phi^*_{\EC}(G)$ without composing the transformations.
\end{remark}

Let $f_w$ be an EC* convolutional operator. In the general case~\ref{enum:i}, $w \in \cs(V)$, so its support is $\cm = \varphi(\cn)$ such that $\cn \subseteq \cu$. In the abelian case~\ref{enum:ii}, we use instead $w \in \cs(\Gamma)$, and thus its support is directly $\cn$.
Therefore, we can rewrite the expressions of the convolution operator as:
\begin{enumerate}[label=(\roman*)]
  \item $\forall s \in \cs(V), \forall u \in V, f_w(s)[u]
          \overset{(\varphi)}= \displaystyle\sum_{v \in \ck_u} s[v] \h{2} w[g_v^{-1}(u)]$ \label{enum:i}
  \item $\forall s \in \cs(V), f_w(s) \overset{(\M)}= \displaystyle\sum_{g \in \cn} w[g] \h{2} g(s)$ \label{enum:ii}
\end{enumerate}

\begin{remark}
Note that in the abelian case, we can see from \ref{enum:ii} that a definition of a local patch would coincide with the supporting set, so that locality and weight sharing is straightforward.
\end{remark}

\paragraph{Construction}
From these expressions, it is clear that $\Gamma$ needs not to be fully determined to calculate $f_w(s)[u]$. The case \ref{enum:ii} is the simplest as the only requirement is a supporting set $\cn$ of EC invertible transformations. In the case \ref{enum:i}, we also need to determine $\ck_u$.

\paragraph{Strict locality}
Note that $f_w(s)[u]$ is a weighted aggregation of entries $s[v]$ for $v \in \ck_u$. As $\ck_{\id} = \varphi(\cn^{-1}) = \cn^{-1}(\varphi(\id))$, $\ck_{\id}$ contains only neighbors of $\varphi(\id)$, and so $\ck_u = g_u(\ck_{\id})$ contains only neighbors of $u$. Therefore, in both cases $f_w(s)[u]$ is a weighted aggregation of entries located in the neighborhood of~$u$.

\paragraph{Complexity}
Another merit is that EC* convolutions have a complexity of $\co(kn)$, where $n = |V|$ is the order of the graph, and $k = |\cn|$ is the size of the weight kernel. In comparison, EC convolutions have complexity up to $\co(n^2)$.

%\paragraph{What exactly is the local patch $\ck_u$ ?}

%\todo{or not todo?}

%\subsection{On the choice of the supporting set $\cn$}

%\paragraph{Exploiting subgraph symmetries}

